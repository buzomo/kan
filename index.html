<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Áí∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2285%22>ü•è</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .smart-mode-cursor {
            caret-color: rgb(172, 46, 197);
        }
        .plain-text-mode-cursor {
            caret-color: black;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "BIZ UDGothic";
          }
          
          body {
            font-family: sans-serif;
            background-color: #f0f0f0; /* „Ç∞„É¨„Éº */
          }
          
          .container {
            display: flex;
            min-height: 100vh;
          }
          
          .sidebar {
            width: 25%;
            background: #e0e0e0; /* „Ç∞„É¨„Éº */
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
          }
          
          .content {
            width: 50%;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            background: #d0d0d0; /* „Ç∞„É¨„Éº */
          }
          
          .backlinks {
            width: 25%;
            background: #e0e0e0; /* „Ç∞„É¨„Éº */
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
          }
          
          .page-list {
            list-style: none;
            overflow-y: scroll;
          }
          
          ::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
          }
          
          .page-list li {
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            background: #f0f0f0; /* „Ç∞„É¨„Éº */
          }
          
          .page-list li:hover {
            background: #d0d0d0; /* „Ç∞„É¨„Éº */
          }
          
          .page-list .title {
            font-weight: bold;
            margin-bottom: 4px;
          }
          
          .page-list .preview {
            font-size: 0.9em;
            color: #888; /* „Ç∞„É¨„Éº */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
          }
          
          .page-list .thumbnail {
            max-width: 100%;
            height: auto;
            margin-top: 8px;
          }
          
          .active {
            background: #d0d0d0; /* „Ç∞„É¨„Éº */
          }
          
          #content-area {
            width: 100%;
            height: calc(100vh - 40px); /* ÁîªÈù¢„ÅÑ„Å£„Å±„ÅÑ„ÅÆÈ´ò„Åï„Å´Ë®≠ÂÆö */
            padding: 10px;
            font-family: inherit;
            resize: vertical;
            display: none;
            background: #f0f0f0; /* „Ç∞„É¨„Éº */
          }
          
          #content-area.edit-mode {
            font-size: 1.1em;
            line-height: 2em;
          }
          
          #preview-area {
            padding: 10px;
            height: 100%;
          }
          
          #preview-area img {
            max-width: 100%;
          }
          
          #preview-area p {
            margin-bottom: 1.5em; /* Ë°åÈñì„ÇíÂ∫É„Åí„Çã */
            line-height: 1.5; /* Ë°åÈñì„ÇíÂ∫É„Åí„Çã */
          }
          
          .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 16px;
            background: #f0f0f0; /* „Ç∞„É¨„Éº */
          }
          
          .button-group {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: row;
          }
          
          .button-group button {
            background: none;
            border: none;
            cursor: pointer;
            margin: 0 5px;
            opacity: 0.2;
            transition: opacity 0.3s;
          }
          
          .button-group button:hover {
            opacity: 1;
          }
          
          .button-group button i {
            font-size: 24px;
            color: #888; /* „Ç∞„É¨„Éº */
          }
          
          .button-group button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 35px;
            background: #888; /* „Ç∞„É¨„Éº */
            color: #fff;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
            transform: translateX(-50%);
            left: 50%;
          }
          
          .button-group button:last-child:hover::after {
            left: auto;
            right: 0;
            transform: translateX(0);
          }
          
          /* „Çπ„Çø„Ç§„É´ËøΩÂä† */
          .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-family: sans-serif;
            transition: opacity 0.3s;
          }
          
          .toast-success {
            background: #4caf50;
          }
          .toast-error {
            background: #f44336;
          }
          .toast-warning {
            background: #ff9800;
          }
          .toast-info {
            background: #2196f3;
          }
          
          .fade-out {
            opacity: 0;
          }
          
          .auto-save-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 0.8em;
            color: #666;
          }
          
          .toast button {
            background: none;
            border: none;
            color: #ff9800;
            cursor: pointer;
            margin-left: 10px;
          }
          
          /* Marked.js„Å´„Çà„Çã„Éó„É¨„Éì„É•„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
          #preview-area h1,
          #preview-area h2,
          #preview-area h3,
          #preview-area h4,
          #preview-area h5,
          #preview-area h6 {
            margin-top: 1.5em; /* Ë°åÈñì„ÇíÂ∫É„Åí„Çã */
            margin-bottom: 1em; /* Ë°åÈñì„ÇíÂ∫É„Åí„Çã */
            line-height: 2em; /* Ë°åÈñì„ÇíÂ∫É„Åí„Çã */
            font-weight: bold;
            letter-spacing: 2px;
          }
          h2 {
            margin-bottom: 1em !important;
          }
          
          #preview-area p {
            margin-bottom: 1.5em; /* Ë°åÈñì„ÇíÂ∫É„Åí„Çã */
          }
          
          #preview-area ul,
          #preview-area ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
            line-height: 2em;
            letter-spacing: 2px;
          }
          
          #preview-area blockquote {
            margin: 1em 0;
            padding-left: 1em;
            border-left: 4px solid #888; /* „Ç∞„É¨„Éº */
            color: #555;
          }
          
          #preview-area code {
            background: #d0d0d0; /* „Ç∞„É¨„Éº */
            padding: 0.2em 0.4em;
            border-radius: 3px;
          }
          
          .copy-sign {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #888; /* „Ç∞„É¨„Éº */
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
          }
          
          a {
            color: #888; /* „Ç∞„É¨„Éº */
            font-weight: bold;
            text-decoration: none;
          }
          
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <input type="text" class="search-box" id="search-box" placeholder="„Çø„Ç§„Éà„É´„ÇíÊ§úÁ¥¢...">
            <ul class="page-list" id="page-list"></ul>
        </div>
        <div class="content">
            <textarea id="content-area"></textarea>
            <div id="preview-area"></div>
            <div class="button-group">
                <button id="delete-page" data-tooltip="„Éö„Éº„Ç∏ÂâäÈô§">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="random-page" data-tooltip="„É©„É≥„ÉÄ„É†„Éö„Éº„Ç∏">
                    <i class="fas fa-random"></i>
                </button>
                <button id="upload-button" data-tooltip="„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ">
                    <i class="fas fa-upload"></i>
                </button>
                <button id="search-yahoo" data-tooltip="Yahoo„É™„Ç¢„É´„Çø„Ç§„É†Ê§úÁ¥¢">
                    <i class="fas fa-search"></i>
                </button>
                <button id="search-google" data-tooltip="Google„Åä‰ªª„ÅõÊ§úÁ¥¢">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="backlinks">
            <h2>„Éê„ÉÉ„ÇØ„É™„É≥„ÇØ</h2>
            <input type="text" class="search-box" id="backlinks-search-box" placeholder="„Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„ÇíÊ§úÁ¥¢...">
            <ul class="page-list" id="backlinks-list"></ul>
            <h2 style="margin-top: 40px;">„É™„É≥„ÇØ</h2>
            <input type="text" class="search-box" id="links-search-box" placeholder="„É™„É≥„ÇØ„ÇíÊ§úÁ¥¢...">
            <ul class="page-list" id="links-list"></ul>
        </div>
    </div>

    <script>
        const store = {
            pages: {},
            save() {
                localStorage.setItem('pages', JSON.stringify(this.pages));
            },
            async load() {
                const savedPages = localStorage.getItem('pages');
                if (savedPages) {
                    this.pages = JSON.parse(savedPages);
                } else {
                    const response = await fetch('contents.json');
                    const data = await response.json();
                    this.pages = data;
                }
            }
        };

        let currentRequest = null;
        const contentArea = document.getElementById('content-area');
        const previewArea = document.getElementById('preview-area');
        let currentPage = '';
        let isSmartMode = true;
        let originalContent = '';

        // „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„ÅÆË®≠ÂÆö
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // „Éó„É¨„Éì„É•„Éº„ÅÆÊõ¥Êñ∞
        function updatePreview() {
            let content = contentArea.value;
            const lines = content.split('\n');
            const titleLine = lines[0];
            const newTitle = titleLine.replace(/^#\s*/, '');

            if (newTitle !== currentPage) {
                const oldContent = store.pages[currentPage];
                delete store.pages[currentPage];
                currentPage = newTitle;
                store.pages[currentPage] = oldContent.replace(/^#\s*[^\n]*/, titleLine);
                updateUrlAndTitle(currentPage);
            } else {
                store.pages[currentPage] = content;
            }

            store.save();
            renderPreview();
            updatePageList();
            updateBacklinks(); // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„ÅÆÊõ¥Êñ∞„ÇíËøΩÂä†
        }

        // „Éó„É¨„Éì„É•„Éº„ÅÆË°®Á§∫
        function renderPreview(content = store.pages[currentPage]) {
            if (!content) return;

            let html = marked.parse(content);
            // WikiLinks [text] „Çí <a> „Çø„Ç∞„Å´Â§âÊèõ
            html = html.replace(/\[([^\]]+)\]/g, (match, p1) => {
                return `<a href="#" onclick="showContent('${p1}');return false;">${p1}</a>`;
            });
            previewArea.innerHTML = html;
        }

        // ÁîªÂÉè„ÅÆÂ≠òÂú®„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈñ¢Êï∞
        function checkImage(url, callback) {
            const img = new Image();
            img.onload = () => callback(true);
            img.onerror = () => callback(false);
            img.src = url;
        }

        // „Éö„Éº„Ç∏„É™„Çπ„Éà„ÅÆÊõ¥Êñ∞
        function updatePageList(searchTerm = '') {
            const pageList = document.getElementById('page-list');
            pageList.innerHTML = '';

            const entries = Object.entries(store.pages).reverse(); // ÈÄÜÈ†Ü„Å´Â§âÊõ¥

            entries.forEach(([title, content]) => {
                const firstLine = content.split('\n')[0].replace(/^#\s*/, '');
                if (!firstLine.toLowerCase().includes(searchTerm.toLowerCase())) return;

                const li = document.createElement('li');
                li.onclick = () => showContent(title);
                li.onmouseover = () => renderPreview(content); // „Éõ„Éê„Éº„Åß„Éó„É¨„Éì„É•„Éº
                li.onmouseout = () => renderPreview(originalContent); // „Éõ„Éê„ÉºËß£Èô§„ÅßÂÖÉ„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çã
                if (title === currentPage) li.classList.add('active');

                const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
                if (imgMatch) {
                    // ÁîªÂÉè„Åå„ÅÇ„ÇãÂ†¥Âêà
                    checkImage(imgMatch[1], (exists) => {
                        if (exists) {
                            li.innerHTML = `
                                <div class="title">${title}</div>
                                <img class="thumbnail" src="${imgMatch[1]}" alt="${title}">
                            `;
                        } else {
                            const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                            li.innerHTML = `
                                <div class="title">${title}</div>
                                <div class="preview">${preview}</div>
                            `;
                        }
                        pageList.appendChild(li);
                    });
                } else {
                    // ÁîªÂÉè„Åå„Å™„ÅÑÂ†¥Âêà
                    const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                    li.innerHTML = `
                        <div class="title">${title}</div>
                        <div class="preview">${preview}</div>
                    `;
                    pageList.appendChild(li);
                }
            });
        }

        // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„Å®„É™„É≥„ÇØÂÖà„ÅÆÊõ¥Êñ∞
        function updateBacklinks() {
            const backlinkslist = document.getElementById('backlinks-list');
            const linkslist = document.getElementById('links-list');
            const backlinksSearchBox = document.getElementById('backlinks-search-box');
            const linksSearchBox = document.getElementById('links-search-box');
            backlinkslist.innerHTML = '';
            linkslist.innerHTML = '';

            let backlinksCount = 0;
            let linksCount = 0;

            Object.entries(store.pages).forEach(([title, content]) => {
                if (title === currentPage) return;

                const hasBacklink = content.includes(`[${currentPage}]`);
                const hasLink = store.pages[currentPage].includes(`[${title}]`);

                if (hasBacklink) {
                    backlinksCount++;
                    const li = document.createElement('li');
                    li.onclick = () => showContent(title);

                    const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch) {
                        checkImage(imgMatch[1], (exists) => {
                            if (exists) {
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <img class="thumbnail" src="${imgMatch[1]}" alt="${title}">
                                `;
                            } else {
                                const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <div class="preview">${preview}</div>
                                `;
                            }
                            backlinkslist.appendChild(li);
                        });
                    } else {
                        const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                        li.innerHTML = `
                            <div class="title">${title}</div>
                            <div class="preview">${preview}</div>
                        `;
                        backlinkslist.appendChild(li);
                    }
                }

                if (hasLink) {
                    linksCount++;
                    const li = document.createElement('li');
                    li.onclick = () => showContent(title);

                    const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch) {
                        checkImage(imgMatch[1], (exists) => {
                            if (exists) {
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <img class="thumbnail" src="${imgMatch[1]}" alt="${title}">
                                `;
                            } else {
                                const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <div class="preview">${preview}</div>
                                `;
                            }
                            linkslist.appendChild(li);
                        });
                    } else {
                        const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                        li.innerHTML = `
                            <div class="title">${title}</div>
                            <div class="preview">${preview}</div>
                        `;
                        linkslist.appendChild(li);
                    }
                }
            });

            // „Éö„Éº„Ç∏„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„É™„É≥„ÇØ„ÇÇË°®Á§∫
            const links = store.pages[currentPage].match(/\[([^\]]+)\]/g) || [];
            links.forEach(link => {
                const title = link.replace(/[\[\]]/g, '');
                if (!store.pages[title]) {
                    const li = document.createElement('li');
                    li.onclick = () => showContent(title);
                    li.innerHTML = `
                        <div class="title">${title}</div>
                        <div class="preview">Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>
                    `;
                    linkslist.appendChild(li);
                }
            });

            backlinksSearchBox.disabled = backlinksCount === 0;
            linksSearchBox.disabled = linksCount === 0 && links.length === 0;
        }

        // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„Å®„É™„É≥„ÇØ„ÅÆ„Éï„Ç£„É´„Çø„Éº
        document.getElementById('backlinks-search-box').addEventListener('input', (e) => {
            filterList('backlinks-list', e.target.value);
        });

        document.getElementById('links-search-box').addEventListener('input', (e) => {
            filterList('links-list', e.target.value);
        });

        function filterList(listId, searchTerm) {
            const list = document.getElementById(listId);
            const items = list.getElementsByTagName('li');
            for (let i = 0; i < items.length; i++) {
                const title = items[i].getElementsByClassName('title')[0].innerText;
                if (title.toLowerCase().includes(searchTerm.toLowerCase())) {
                    items[i].style.display = '';
                } else {
                    items[i].style.display = 'none';
                }
            }
        }

        // URL„Éë„É©„É°„Éº„Çø„Éº„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´„Å®URL„Éë„É©„É°„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
        function updateUrlAndTitle(title) {
            document.title = title + ' - Áí∞';
            const newUrl = `${window.location.origin}${window.location.pathname}?page=${encodeURIComponent(title)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
        }

        // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫
        function showContent(title) {
            currentPage = title;
            if (!store.pages[title]) {
                store.pages[title] = `# ${title}\n`;
                store.save();
            }
            contentArea.value = store.pages[title];
            originalContent = store.pages[title]; // ÂÖÉ„ÅÆ„Éö„Éº„Ç∏ÂÜÖÂÆπ„Çí‰øùÂ≠ò
            renderPreview();
            updatePageList();
            updateBacklinks();
            updateUrlAndTitle(title);
        }

        // „Çø„Ç§„Éà„É´„ÅÆ„Åø„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÁä∂ÊÖã„Åß2Ë°åÁõÆ„Å´"- "„ÇíËøΩË®ò„Åó„ÄÅ„Ç´„Éº„ÇΩ„É´„Çí„Åù„ÅÆÊú´Â∞æ„Å´ÁßªÂãï
        function addBulletPoint() {
            const lines = contentArea.value.split('\n');
            if (lines.length === 1 && lines[0].startsWith('# ')) {
                contentArea.value += '\n- ';
                contentArea.setSelectionRange(contentArea.value.length, contentArea.value.length);
            } else if (lines.length === 2 && lines[0].startsWith('# ') && lines[1] === '') {
                contentArea.value += '- ';
                contentArea.setSelectionRange(contentArea.value.length, contentArea.value.length);
            }
        }

        // „ÄåÊ∞ó„ÅåÂà©„Åè„É¢„Éº„Éâ„Äç„Å®„Äå„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„É¢„Éº„Éâ„Äç„ÅÆÂàá„ÇäÊõø„Åà
        function toggleMode() {
            isSmartMode = !isSmartMode;
            if (isSmartMode) {
                contentArea.classList.add('smart-mode-cursor');
                contentArea.classList.remove('plain-text-mode-cursor');
            } else {
                contentArea.classList.add('plain-text-mode-cursor');
                contentArea.classList.remove('smart-mode-cursor');
            }
        }

        // Alt„Ç≠„Éº„Åß„É¢„Éº„Éâ„Çí„Éà„Ç∞„É´
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && !contentArea.matches(':focus')) {
                toggleMode();
            }
        });

        // Ctrl+K„ÅßÊ§úÁ¥¢„Éê„Éº„Å´„Éï„Ç©„Éº„Ç´„Çπ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('search-box').focus();
            }
        });

        // ÂàùÊúü„É¢„Éº„ÉâË®≠ÂÆö
        if (isSmartMode) {
            contentArea.classList.add('smart-mode-cursor');
        } else {
            contentArea.classList.add('plain-text-mode-cursor');
        }

        // „ÄåÊ∞ó„ÅåÂà©„Åè„É¢„Éº„Éâ„Äç„ÅÆÂãï‰Ωú
        function smartModeHandler(e) {
            if (e.key === 'Enter') {
                const cursorPosition = contentArea.selectionStart;
                const textBeforeCursor = contentArea.value.substring(0, cursorPosition);
                const textAfterCursor = contentArea.value.substring(cursorPosition);
                const currentLine = textBeforeCursor.split('\n').pop();

                if (currentLine.startsWith('# ')) {
                    e.preventDefault();
                    contentArea.value = textBeforeCursor + '\n- ' + textAfterCursor;
                    contentArea.setSelectionRange(cursorPosition + 3, cursorPosition + 3);
                } else if (currentLine.startsWith('- ') && currentLine !== '- ') {
                    e.preventDefault();
                    contentArea.value = textBeforeCursor + '\n- ' + textAfterCursor;
                    contentArea.setSelectionRange(cursorPosition + 3, cursorPosition + 3);
                } else if (currentLine === '- ') {
                    e.preventDefault();
                    contentArea.value = textBeforeCursor + '\n\n# ' + textAfterCursor;
                    contentArea.setSelectionRange(cursorPosition + 4, cursorPosition + 4);
                }
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        contentArea.addEventListener('input', () => {
            updatePreview();
            updateBacklinks(); // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„ÅÆÊõ¥Êñ∞„ÇíËøΩÂä†
        });
        contentArea.addEventListener('focus', () => {
            contentArea.style.display = 'block';
            previewArea.style.display = 'none';
            contentArea.classList.add('edit-mode');
            addBulletPoint();
        });
        contentArea.addEventListener('blur', () => {
            contentArea.style.display = 'none';
            previewArea.style.display = 'block';
            contentArea.classList.remove('edit-mode');
        });

        // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Á∑®ÈõÜ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
        previewArea.addEventListener('click', () => {
            contentArea.style.display = 'block';
            previewArea.style.display = 'none';
            contentArea.classList.add('edit-mode');
            contentArea.focus();
        });

        // Á∑®ÈõÜ„Ç®„É™„Ç¢„ÅÆÂ§ñ„Å´„Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´„ÅåÁßªÂãï„Åó„ÅüÂ†¥Âêà„Å´Èñ≤Ë¶ß„É¢„Éº„Éâ„Å´Êàª„Åô
        document.addEventListener('mousemove', (e) => {
            if (!contentArea.contains(e.target) && !previewArea.contains(e.target)) {
                contentArea.style.display = 'none';
                previewArea.style.display = 'block';
                contentArea.classList.remove('edit-mode');
            }
        });

        contentArea.addEventListener('keydown', (e) => {
            if (isSmartMode) {
                smartModeHandler(e);
            }
        });

        document.getElementById('search-box').addEventListener('input', (e) => {
            updatePageList(e.target.value);
        });

        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied to clipboard');
                showCopySign();
            });
        }
// CookieÊìç‰Ωú„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„ÇíLocalStorageÊìç‰Ωú„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„Å´Â§âÊõ¥
function getLocalStorageToken(name) {
    return localStorage.getItem(name);
}

// Base64„Ç®„É≥„Ç≥„Éº„ÉâÈñ¢Êï∞
function base64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
    }));
}

// GitHubÈÄ£Êê∫„É¢„Ç∏„É•„Éº„É´
const GitHubSync = (() => {
    let currentRequest = null;
    let retryCount = 0;
    const maxRetries = 3;

    async function getFileSHA() {
        try {
            const response = await fetch(
                'https://api.github.com/repos/buzomo/kan/contents/contents.json',
                {
                    headers: {
                        'Authorization': `token ${getLocalStorageToken('gh_token')}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );
            
            if (!response.ok) throw new Error('SHAÂèñÂæóÂ§±Êïó');
            const data = await response.json();
            return data.sha;
        } catch (error) {
            updateUploadButtonTooltip(`„Ç®„É©„Éº: ${error.message}`);
            throw error;
        }
    }

    async function pushToGitHub(content) {
        const controller = new AbortController();
        currentRequest = controller;

        try {
            const sha = await getFileSHA();
            const response = await fetch(
                'https://api.github.com/repos/buzomo/kan/contents/contents.json',
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${getLocalStorageToken('gh_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Auto-save ${new Date().toISOString()}`,
                        content: base64EncodeUnicode(JSON.stringify(content)),
                        sha: sha
                    }),
                    signal: controller.signal
                }
            );

            if (response.status === 409) {
                throw new Error('sha mismatch');
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message);
            }

            retryCount = 0;
            return true;
        } catch (error) {
            if (error.name === 'AbortError') return;
            throw error;
        } finally {
            currentRequest = null;
        }
    }

    return {
        async autoSave(content) {
            try {
                await pushToGitHub(content);
                updateUploadButtonTooltip('Ëá™Âãï‰øùÂ≠òÊàêÂäü');
                return true;
            } catch (error) {
                if (error.message === 'sha mismatch' && retryCount < maxRetries) {
                    retryCount++;
                    updateUploadButtonTooltip(`ÂÜçË©¶Ë°å‰∏≠ (${retryCount}/${maxRetries})`);
                    return this.autoSave(content);
                }
                updateUploadButtonTooltip(`‰øùÂ≠òÂ§±Êïó: ${error.message}`);
                return false;
            }
        }
    };
})();

// Ëá™Âãï‰øùÂ≠òÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
const AutoSaveManager = (() => {
    let timeoutId;
    let isSaving = false;
    const debounceTime = 2000;

    async function handleInput() {
        clearTimeout(timeoutId);
        if (currentRequest) currentRequest.abort();

        timeoutId = setTimeout(async () => {
            if (!getLocalStorageToken('gh_token')) {
                showToast('GitHub„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                isSaving = true;
                await GitHubSync.autoSave(store.pages);
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº', error);
            } finally {
                isSaving = false;
            }
        }, debounceTime);
    }

    return {
        init() {
            const contentArea = document.getElementById('content-area');
            contentArea.addEventListener('input', handleInput);
        }
    };
})();

// UIÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-icon"></div>
        <div class="toast-message">${message}</div>
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('fade-out'), 2500);
    setTimeout(() => toast.remove(), 3000);
}

// „Çπ„Çø„Ç§„É´ÂãïÁöÑËøΩÂä†
const style = document.createElement('style');
style.textContent = `
    .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        display: flex;
        align-items: center;
        gap: 12px;
        opacity: 1;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .toast-success { background: #00c853; }
    .toast-error { background: #d50000; }
    .toast-warning { background: #ffab00; }
    .toast-info { background: #2962ff; }

    .fade-out {
        opacity: 0 !important;
        transform: translateY(20px);
    }

    .toast-icon {
        width: 20px;
        height: 20px;
        background: rgba(255,255,255,0.3);
        border-radius: 50%;
    }
`;
document.head.appendChild(style);

// ÂàùÊúüÂåñÂá¶ÁêÜ
document.addEventListener('DOMContentLoaded', () => {
    AutoSaveManager.init();
    
    // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥ÔºàÊâãÂãï‰øùÂ≠òÁî®Ôºâ
    document.getElementById('upload-button').addEventListener('click', async () => {
        updateUploadButtonTooltip('‰øùÂ≠ò‰∏≠...');
        const success = await GitHubSync.autoSave(store.pages);
        if (success) {
            updateUploadButtonTooltip('‰øùÂ≠òÊàêÂäü');
        } else {
            updateUploadButtonTooltip('‰øùÂ≠òÂ§±Êïó');
        }
    });

    // gh_token„ÅÆÂÖàÈ†≠5ÊñáÂ≠ó„Çí„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Å´Ë°®Á§∫
    const ghToken = getLocalStorageToken('gh_token');
    if (ghToken) {
        updateUploadButtonTooltip(`gh_token: ${ghToken.substring(0, 5)}`);
    }

    // ÂàùÊúüË°®Á§∫
    store.load().then(() => {
        const initialPage = getUrlParameter('page') || 'Home';
        showContent(initialPage);
    });
});

        // „Éö„Éº„Ç∏ÂâäÈô§
        document.getElementById('delete-page').addEventListener('click', async () => {
            if (currentPage && store.pages[currentPage]) {
                const deletedPage = store.pages[currentPage];
                delete store.pages[currentPage];
                store.save();
                showToast('„Éö„Éº„Ç∏„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü', async () => {
                    store.pages[currentPage] = deletedPage;
                    store.save();
                    showContent(currentPage);
                    await GitHubSync.autoSave(store.pages); // Ëá™Âãï‰øùÂ≠ò„ÇíËøΩÂä†
                });
                showContent('Home');
                await GitHubSync.autoSave(store.pages); // Ëá™Âãï‰øùÂ≠ò„ÇíËøΩÂä†
            }
        });

        // „É©„É≥„ÉÄ„É†„Éö„Éº„Ç∏Ë°®Á§∫
        document.getElementById('random-page').addEventListener('click', () => {
            const keys = Object.keys(store.pages);
            if (keys.length > 1) {
                let randomPage;
                do {
                    randomPage = keys[Math.floor(Math.random() * keys.length)];
                } while (randomPage === currentPage);
                showContent(randomPage);
            } else if (keys.length === 1) {
                showContent(keys[0]);
            }
        });

        // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥
        document.getElementById('upload-button').addEventListener('click', () => {
            window.open('https://time.is', '_blank', 'width=500,height=500,toolbar=no,scrollbars=no');
        });

        // „Éà„Éº„Çπ„ÉàË°®Á§∫
        function showToast(message, undoCallback) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `${message} <button id="undo-button">Âèñ„ÇäÊ∂à„Åó</button>`;
            document.body.appendChild(toast);

            document.getElementById('undo-button').addEventListener('click', () => {
                undoCallback();
                document.body.removeChild(toast);
            });

            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 2000);
        }

        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åü„Å®„Åç„ÅÆ„Çµ„Ç§„É≥Ë°®Á§∫
        function showCopySign() {
            const sign = document.createElement('div');
            sign.className = 'copy-sign';
            sign.innerText = 'Copied!';
            document.body.appendChild(sign);

            setTimeout(() => {
                document.body.removeChild(sign);
            }, 2000);
        }

        // Ê§úÁ¥¢ÁµêÊûú„Åå„Éí„ÉÉ„Éà„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆÊñ∞Ë¶è„Éö„Éº„Ç∏‰ΩúÊàê
        document.getElementById('search-box').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value;
                if (!Object.keys(store.pages).some(title => title.toLowerCase().includes(searchTerm.toLowerCase()))) {
                    store.pages[searchTerm] = `# ${searchTerm}\n`;
                    store.save();
                    showContent(searchTerm);
                    contentArea.focus();
                }
            }
        });

        // „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´„ÅßWebÊ§úÁ¥¢„Åô„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('search-yahoo').addEventListener('click', () => {
            const url = `https://search.yahoo.co.jp/realtime/search?p=${encodeURIComponent(currentPage)}`;
            window.open(url, '_blank');
        });

        document.getElementById('search-google').addEventListener('click', () => {
            const url = `https://www.google.com/search?btnI=I&q=${encodeURIComponent(currentPage)}`;
            window.open(url, '_blank');
        });

        // ÂàùÊúüË°®Á§∫
        store.load().then(() => {
            const initialPage = getUrlParameter('page') || 'Home';
            showContent(initialPage);
        });
    </script>
</body>
</html>