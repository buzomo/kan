<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Áí∞</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2285%22>ü•è</text></svg>">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .smart-mode-cursor {
            caret-color: rgb(172, 46, 197);
        }
        .plain-text-mode-cursor {
            caret-color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <input type="text" class="search-box" id="search-box" placeholder="„Çø„Ç§„Éà„É´„ÇíÊ§úÁ¥¢...">
            <ul class="page-list" id="page-list"></ul>
        </div>
        <div class="content">
            <textarea id="content-area"></textarea>
            <div id="preview-area"></div>
            <div class="button-group">
                <button id="delete-page" data-tooltip="„Éö„Éº„Ç∏ÂâäÈô§">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button id="random-page" data-tooltip="„É©„É≥„ÉÄ„É†„Éö„Éº„Ç∏">
                    <i class="fas fa-random"></i>
                </button>
                <button id="upload-button" data-tooltip="„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ">
                    <i class="fas fa-upload"></i>
                </button>
                <button id="search-yahoo" data-tooltip="Yahoo„É™„Ç¢„É´„Çø„Ç§„É†Ê§úÁ¥¢">
                    <i class="fas fa-search"></i>
                </button>
                <button id="search-google" data-tooltip="Google„Åä‰ªª„ÅõÊ§úÁ¥¢">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="backlinks">
            <h2>„Éê„ÉÉ„ÇØ„É™„É≥„ÇØ</h2>
            <input type="text" class="search-box" id="backlinks-search-box" placeholder="„Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„ÇíÊ§úÁ¥¢...">
            <ul class="page-list" id="backlinks-list"></ul>
            <h2 style="margin-top: 40px;">„É™„É≥„ÇØ</h2>
            <input type="text" class="search-box" id="links-search-box" placeholder="„É™„É≥„ÇØ„ÇíÊ§úÁ¥¢...">
            <ul class="page-list" id="links-list"></ul>
        </div>
    </div>

    <script>
        const store = {
            pages: {},
            save() {
                localStorage.setItem('wikiPages', JSON.stringify(this.pages));
            },
            async load() {
                const response = await fetch('contents.json');
                const data = await response.json();
                this.pages = JSON.parse(localStorage.getItem('wikiPages')) || data;
            }
        };

        const contentArea = document.getElementById('content-area');
        const previewArea = document.getElementById('preview-area');
        let currentPage = '';
        let isSmartMode = true;

        // „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„ÅÆË®≠ÂÆö
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // „Éó„É¨„Éì„É•„Éº„ÅÆÊõ¥Êñ∞
        function updatePreview() {
            let content = contentArea.value;
            const titleLine = `# ${currentPage}\n`;
            if (!content.startsWith(titleLine)) {
                content = titleLine + content.split('\n').slice(1).join('\n');
                contentArea.value = content;
            }
            store.pages[currentPage] = content;
            store.save();
            renderPreview();
            updatePageList();
            updateBacklinks(); // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„ÅÆÊõ¥Êñ∞„ÇíËøΩÂä†
        }

        // „Éó„É¨„Éì„É•„Éº„ÅÆË°®Á§∫
        function renderPreview() {
            const content = store.pages[currentPage];
            if (!content) return;

            let html = marked.parse(content);
            // WikiLinks [text] „Çí <a> „Çø„Ç∞„Å´Â§âÊèõ
            html = html.replace(/\[([^\]]+)\]/g, (match, p1) => {
                return `<a href="#" onclick="showContent('${p1}');return false;">${p1}</a>`;
            });
            previewArea.innerHTML = html;
        }

        // ÁîªÂÉè„ÅÆÂ≠òÂú®„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈñ¢Êï∞
        function checkImage(url, callback) {
            const img = new Image();
            img.onload = () => callback(true);
            img.onerror = () => callback(false);
            img.src = url;
        }

        // „Éö„Éº„Ç∏„É™„Çπ„Éà„ÅÆÊõ¥Êñ∞
        function updatePageList(searchTerm = '') {
            const pageList = document.getElementById('page-list');
            pageList.innerHTML = '';

            Object.entries(store.pages).forEach(([title, content]) => {
                const firstLine = content.split('\n')[0].replace(/^#\s*/, '');
                if (!firstLine.toLowerCase().includes(searchTerm.toLowerCase())) return;

                const li = document.createElement('li');
                li.onclick = () => showContent(title);
                if (title === currentPage) li.classList.add('active');

                const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
                if (imgMatch) {
                    // ÁîªÂÉè„Åå„ÅÇ„ÇãÂ†¥Âêà
                    checkImage(imgMatch[1], (exists) => {
                        if (exists) {
                            li.innerHTML = `
                                <div class="title">${title}</div>
                                <img class="thumbnail" src="${imgMatch[1]}" alt="${title}">
                            `;
                        } else {
                            const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                            li.innerHTML = `
                                <div class="title">${title}</div>
                                <div class="preview">${preview}</div>
                            `;
                        }
                        pageList.appendChild(li);
                    });
                } else {
                    // ÁîªÂÉè„Åå„Å™„ÅÑÂ†¥Âêà
                    const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                    li.innerHTML = `
                        <div class="title">${title}</div>
                        <div class="preview">${preview}</div>
                    `;
                    pageList.appendChild(li);
                }
            });
        }

        // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„Å®„É™„É≥„ÇØÂÖà„ÅÆÊõ¥Êñ∞
        function updateBacklinks() {
            const backlinkslist = document.getElementById('backlinks-list');
            const linkslist = document.getElementById('links-list');
            const backlinksSearchBox = document.getElementById('backlinks-search-box');
            const linksSearchBox = document.getElementById('links-search-box');
            backlinkslist.innerHTML = '';
            linkslist.innerHTML = '';

            let backlinksCount = 0;
            let linksCount = 0;

            Object.entries(store.pages).forEach(([title, content]) => {
                if (title === currentPage) return;

                const hasBacklink = content.includes(`[${currentPage}]`);
                const hasLink = store.pages[currentPage].includes(`[${title}]`);

                if (hasBacklink) {
                    backlinksCount++;
                    const li = document.createElement('li');
                    li.onclick = () => showContent(title);

                    const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch) {
                        checkImage(imgMatch[1], (exists) => {
                            if (exists) {
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <img class="thumbnail" src="${imgMatch[1]}" alt="${title}">
                                `;
                            } else {
                                const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <div class="preview">${preview}</div>
                                `;
                            }
                            backlinkslist.appendChild(li);
                        });
                    } else {
                        const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                        li.innerHTML = `
                            <div class="title">${title}</div>
                            <div class="preview">${preview}</div>
                        `;
                        backlinkslist.appendChild(li);
                    }
                }

                if (hasLink) {
                    linksCount++;
                    const li = document.createElement('li');
                    li.onclick = () => showContent(title);

                    const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch) {
                        checkImage(imgMatch[1], (exists) => {
                            if (exists) {
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <img class="thumbnail" src="${imgMatch[1]}" alt="${title}">
                                `;
                            } else {
                                const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                                li.innerHTML = `
                                    <div class="title">${title}</div>
                                    <div class="preview">${preview}</div>
                                `;
                            }
                            linkslist.appendChild(li);
                        });
                    } else {
                        const preview = content.split('\n').slice(1).join(' ').substring(0, 100).replace(/<\/?[^>]+(>|$)/g, "");
                        li.innerHTML = `
                            <div class="title">${title}</div>
                            <div class="preview">${preview}</div>
                        `;
                        linkslist.appendChild(li);
                    }
                }
            });

            // „Éö„Éº„Ç∏„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„É™„É≥„ÇØ„ÇÇË°®Á§∫
            const links = store.pages[currentPage].match(/\[([^\]]+)\]/g) || [];
            links.forEach(link => {
                const title = link.replace(/[\[\]]/g, '');
                if (!store.pages[title]) {
                    const li = document.createElement('li');
                    li.onclick = () => showContent(title);
                    li.innerHTML = `
                        <div class="title">${title}</div>
                        <div class="preview">Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Çí‰ΩúÊàê</div>
                    `;
                    linkslist.appendChild(li);
                }
            });

            backlinksSearchBox.disabled = backlinksCount === 0;
            linksSearchBox.disabled = linksCount === 0 && links.length === 0;
        }

        // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„Å®„É™„É≥„ÇØ„ÅÆ„Éï„Ç£„É´„Çø„Éº
        document.getElementById('backlinks-search-box').addEventListener('input', (e) => {
            filterList('backlinks-list', e.target.value);
        });

        document.getElementById('links-search-box').addEventListener('input', (e) => {
            filterList('links-list', e.target.value);
        });

        function filterList(listId, searchTerm) {
            const list = document.getElementById(listId);
            const items = list.getElementsByTagName('li');
            for (let i = 0; i < items.length; i++) {
                const title = items[i].getElementsByClassName('title')[0].innerText;
                if (title.toLowerCase().includes(searchTerm.toLowerCase())) {
                    items[i].style.display = '';
                } else {
                    items[i].style.display = 'none';
                }
            }
        }

        // URL„Éë„É©„É°„Éº„Çø„Éº„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´„Å®URL„Éë„É©„É°„Éº„Çø„Éº„ÇíÊõ¥Êñ∞
        function updateUrlAndTitle(title) {
            document.title = title + ' - Áí∞';
            const newUrl = `${window.location.origin}${window.location.pathname}?page=${encodeURIComponent(title)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
        }

        // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫
        function showContent(title) {
            currentPage = title;
            if (!store.pages[title]) {
                store.pages[title] = `# ${title}\n`;
                store.save();
            }
            contentArea.value = store.pages[title];
            renderPreview();
            updatePageList();
            updateBacklinks();
            updateUrlAndTitle(title);
        }

        // „Çø„Ç§„Éà„É´„ÅÆ„Åø„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÁä∂ÊÖã„Åß2Ë°åÁõÆ„Å´"- "„ÇíËøΩË®ò„Åó„ÄÅ„Ç´„Éº„ÇΩ„É´„Çí„Åù„ÅÆÊú´Â∞æ„Å´ÁßªÂãï
        function addBulletPoint() {
            const lines = contentArea.value.split('\n');
            if (lines.length === 1 && lines[0].startsWith('# ')) {
                contentArea.value += '\n- ';
                contentArea.setSelectionRange(contentArea.value.length, contentArea.value.length);
            } else if (lines.length === 2 && lines[0].startsWith('# ') && lines[1] === '') {
                contentArea.value += '- ';
                contentArea.setSelectionRange(contentArea.value.length, contentArea.value.length);
            }
        }

        // „ÄåÊ∞ó„ÅåÂà©„Åè„É¢„Éº„Éâ„Äç„Å®„Äå„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„É¢„Éº„Éâ„Äç„ÅÆÂàá„ÇäÊõø„Åà
        function toggleMode() {
            isSmartMode = !isSmartMode;
            if (isSmartMode) {
                contentArea.classList.add('smart-mode-cursor');
                contentArea.classList.remove('plain-text-mode-cursor');
            } else {
                contentArea.classList.add('plain-text-mode-cursor');
                contentArea.classList.remove('smart-mode-cursor');
            }
        }

        // Alt„Ç≠„Éº„Åß„É¢„Éº„Éâ„Çí„Éà„Ç∞„É´
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && !contentArea.matches(':focus')) {
                toggleMode();
            }
        });

        // Ctrl+K„ÅßÊ§úÁ¥¢„Éê„Éº„Å´„Éï„Ç©„Éº„Ç´„Çπ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('search-box').focus();
            }
        });

        // ÂàùÊúü„É¢„Éº„ÉâË®≠ÂÆö
        if (isSmartMode) {
            contentArea.classList.add('smart-mode-cursor');
        } else {
            contentArea.classList.add('plain-text-mode-cursor');
        }

        // „ÄåÊ∞ó„ÅåÂà©„Åè„É¢„Éº„Éâ„Äç„ÅÆÂãï‰Ωú
        function smartModeHandler(e) {
            if (e.key === 'Enter') {
                const cursorPosition = contentArea.selectionStart;
                const textBeforeCursor = contentArea.value.substring(0, cursorPosition);
                const textAfterCursor = contentArea.value.substring(cursorPosition);
                const currentLine = textBeforeCursor.split('\n').pop();

                if (currentLine.startsWith('# ')) {
                    e.preventDefault();
                    contentArea.value = textBeforeCursor + '\n- ' + textAfterCursor;
                    contentArea.setSelectionRange(cursorPosition + 3, cursorPosition + 3);
                } else if (currentLine.startsWith('- ') && currentLine !== '- ') {
                    e.preventDefault();
                    contentArea.value = textBeforeCursor + '\n- ' + textAfterCursor;
                    contentArea.setSelectionRange(cursorPosition + 3, cursorPosition + 3);
                } else if (currentLine === '- ') {
                    e.preventDefault();
                    contentArea.value = textBeforeCursor + '\n\n# ' + textAfterCursor;
                    contentArea.setSelectionRange(cursorPosition + 4, cursorPosition + 4);
                }
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        contentArea.addEventListener('input', () => {
            updatePreview();
            updateBacklinks(); // „Éê„ÉÉ„ÇØ„É™„É≥„ÇØ„ÅÆÊõ¥Êñ∞„ÇíËøΩÂä†
        });
        contentArea.addEventListener('focus', () => {
            contentArea.style.display = 'block';
            previewArea.style.display = 'none';
            contentArea.classList.add('edit-mode');
            addBulletPoint();
        });
        contentArea.addEventListener('blur', () => {
            contentArea.style.display = 'none';
            previewArea.style.display = 'block';
            contentArea.classList.remove('edit-mode');
        });

        // „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Á∑®ÈõÜ„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
        previewArea.addEventListener('click', () => {
            contentArea.style.display = 'block';
            previewArea.style.display = 'none';
            contentArea.classList.add('edit-mode');
            contentArea.focus();
        });

        // Á∑®ÈõÜ„Ç®„É™„Ç¢„ÅÆÂ§ñ„Å´„Éû„Ç¶„Çπ„Ç´„Éº„ÇΩ„É´„ÅåÁßªÂãï„Åó„ÅüÂ†¥Âêà„Å´Èñ≤Ë¶ß„É¢„Éº„Éâ„Å´Êàª„Åô
        document.addEventListener('mousemove', (e) => {
            if (!contentArea.contains(e.target) && !previewArea.contains(e.target)) {
                contentArea.style.display = 'none';
                previewArea.style.display = 'block';
                contentArea.classList.remove('edit-mode');
            }
        });

        contentArea.addEventListener('keydown', (e) => {
            if (isSmartMode) {
                smartModeHandler(e);
            }
        });

        document.getElementById('search-box').addEventListener('input', (e) => {
            updatePageList(e.target.value);
        });

        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied to clipboard');
                showCopySign();
            });
        }

        // „Éá„Éº„Çø„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
        let timeout;
        contentArea.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                copyToClipboard(JSON.stringify(store.pages));
            }, 2000);
        });

        // „Éö„Éº„Ç∏ÂâäÈô§
        document.getElementById('delete-page').addEventListener('click', () => {
            if (currentPage && store.pages[currentPage]) {
                const deletedPage = store.pages[currentPage];
                delete store.pages[currentPage];
                store.save();
                showToast('„Éö„Éº„Ç∏„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü', () => {
                    store.pages[currentPage] = deletedPage;
                    store.save();
                    showContent(currentPage);
                });
                showContent('Home');
            }
        });

        // „É©„É≥„ÉÄ„É†„Éö„Éº„Ç∏Ë°®Á§∫
        document.getElementById('random-page').addEventListener('click', () => {
            const keys = Object.keys(store.pages);
            if (keys.length > 1) {
                let randomPage;
                do {
                    randomPage = keys[Math.floor(Math.random() * keys.length)];
                } while (randomPage === currentPage);
                showContent(randomPage);
            } else if (keys.length === 1) {
                showContent(keys[0]);
            }
        });

        // „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥
        document.getElementById('upload-button').addEventListener('click', () => {
            window.open('https://github.com/buzomo/kan/edit/main/contents.json', '_blank', 'width=500,height=500,toolbar=no,scrollbars=no');
        });

        // „Éà„Éº„Çπ„ÉàË°®Á§∫
        function showToast(message, undoCallback) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `${message} <button id="undo-button">Âèñ„ÇäÊ∂à„Åó</button>`;
            document.body.appendChild(toast);

            document.getElementById('undo-button').addEventListener('click', () => {
                undoCallback();
                document.body.removeChild(toast);
            });

            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 10000);
        }

        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åü„Å®„Åç„ÅÆ„Çµ„Ç§„É≥Ë°®Á§∫
        function showCopySign() {
            const sign = document.createElement('div');
            sign.className = 'copy-sign';
            sign.innerText = 'Copied!';
            document.body.appendChild(sign);

            setTimeout(() => {
                document.body.removeChild(sign);
            }, 2000);
        }

        // Ê§úÁ¥¢ÁµêÊûú„Åå„Éí„ÉÉ„Éà„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆÊñ∞Ë¶è„Éö„Éº„Ç∏‰ΩúÊàê
        document.getElementById('search-box').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value;
                if (!Object.keys(store.pages).some(title => title.toLowerCase().includes(searchTerm.toLowerCase()))) {
                    store.pages[searchTerm] = `# ${searchTerm}\n`;
                    store.save();
                    showContent(searchTerm);
                    contentArea.focus();
                }
            }
        });

        // „Éö„Éº„Ç∏„Çø„Ç§„Éà„É´„ÅßWebÊ§úÁ¥¢„Åô„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('search-yahoo').addEventListener('click', () => {
            const url = `https://search.yahoo.co.jp/realtime/search?p=${encodeURIComponent(currentPage)}`;
            window.open(url, '_blank');
        });

        document.getElementById('search-google').addEventListener('click', () => {
            const url = `https://www.google.com/search?btnI=I&q=${encodeURIComponent(currentPage)}`;
            window.open(url, '_blank');
        });

        // ÂàùÊúüË°®Á§∫
        store.load().then(() => {
            const initialPage = getUrlParameter('page') || 'Home';
            showContent(initialPage);
        });
    </script>
</body>
</html>
